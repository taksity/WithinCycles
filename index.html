<!DOCTYPE html>

<html>
    <head>
        <title>
            Within Cycles
        </title>

        <meta charset="UTF8">

        <style>
            :root {
                --base-color: #a1a196;
                --menu-color: #03040e;
                --content-padding: 5px;
            }

            body {
                margin: 0;
                height: 100vh;
                width:  100vw;

                display: flex;

                color: var(--base-color);
            }

            .game_container {
                display: flex;
                flex-direction: column;
                flex-grow: 1;

                background-color: #0f0201;
            }

            .game_contents {
                display: flex;
                flex-direction: row;
                flex-grow: 1;
            }

            .game_header {
                display: flex;
                flex-direction: row;

                background-color: var(--menu-color);

                padding: var(--content-padding);

                border-bottom-style: solid;
                border-bottom-color: var(--base-color);
                border-bottom-width: 7px;
            }

            .banner_title {
                font-family: cursive;
                font-size: 51px;

                flex-grow: 1;

                text-align: center;
            }

            .game_menu {
                display: flex;
                flex-direction: column;

                background-color: var(--menu-color);

                padding: var(--content-padding);

                border-right-style: solid;
                border-right-color: var(--base-color);
                border-right-width: 5px;
            }

            .menu_button_holster {
                display: flex;
                flex-direction: row;
                align-items: center;
                align-content: center;

                flex-grow: 1;
            }

            .journal_button {
                display: none;
            }

            .primary_panel {
                display: flex;
                flex-direction: column;

                flex-grow: 1;
            }

            .narrator {
                flex-grow: 1;

                padding: var(--content-padding);
            }

            .options {
                flex-grow: 0;

                background-color: #09130f;

                padding: var(--content-padding);

                border-top-style: solid;
                border-top-color: var(--base-color);
                border-top-width: 3px;
            }

            .splash_page {
                display: flex;
                flex-direction: column;
                flex-grow: 1;

                background-color: var(--menu-color);
            }

            .splash_top {
                display: flex;
                align-items: end;
                justify-content: center;
                flex-grow: 1;
            }

            .splash_bottom {
                display: flex;
                flex-direction: column;
                align-items: center;
                flex-grow: 1;
            }

            .splash_title {
                font-size: 54pt;
                font-family: cursive;
            }

            .splash_button {
                font-family: 'Courier New', Courier, monospace;
                text-decoration: underline;

                cursor: pointer;
            }

            .logo {
                max-width: 51px;
                max-height: 51px;
            }

            .logo:hover {
                cursor: pointer;
            }

            .info_text {
                padding: 5px;
                text-indent: 3em;
            }

            .notice_options {
                display: flex;
                flex-direction: row;
                align-items: flex-start;
                justify-content: space-evenly;
                
                flex-grow: 1;

                padding-bottom: 5px;
            }
        </style>

        <script>
            /*
                The basic layout of the site is to nest things in div tags
                until it looks right.

                The splash page gives the game a refined look and communicates the game's
                minimalist appearance. The player is given the option to continue or leave
                based on how they receive the title screen.

                The notice page warns users who didn't bother checking the game's description
                or were given the game file with no explanation as to the following:
                    - What kind of game is this?
                    - What kind of stuff will I find?
                    - How sturdy is this game?
                with the hope that they'll be able to make an informed decision about whether
                or not they actually want to play this game.

                After the notice page is the main page which really functions as 7:
                    - The World: the default page the player is brought to which is where
                      they actually play the game and interact with the environment.
                    - File Saves: the place where the player can manage save files
                      including importing and exporting game files.
                    - Settings: I don't know what to put here yet, but I plan on making a
                      way for clever players to fundamentally change the world around them.
                    - Information: the place where the player can read more about the game's
                      internal design.
                    - Help: the place where the player can learn more about how to play
                      the game and what they can interact with, and the games mechanics.
                    - Notice: the player can review the notice if they wish.
                
                The world page consists of 2 parts:
                    - Narrator:
                    - Options:

                The file saves page consists of _ parts:
                    - Create Save:
                    - Import/Export Save:
                    - Load Save:
                
                The settings page IS TO BE DETERMINED

                The information page consists of _ parts:

                The help page consists of 2 parts:
                    - Navigation:
                    - 

                The notice page is just a wall of text and some navigation buttons.
            */

            /* The following lines are old code that needs to be refactored. */

            // Variable checking if the player has journal
            var HasJournal = false;

            // Variable that holds base color.
            var DrawingColor = "#a1a196";

            var Journal = {posession:false,entries:[],relationship:[]};

            // When the player wants to leave.
            function Leave() {
                window.close(); // We try to close the window.
                // Some ways of opening the file prevent the close method from working.
                // So we redirect to a blank page if it fails.
                window.location.replace('about:blank');
                console.clear();
            }

            function LoadTemplate(id) {
                document.body.innerHTML = document.getElementById(id).innerHTML;

                if(id=='game_page') {
                    DrawLogo();

                    LoadPage('the_world');
                }
                else if(id=="splash_screen") {
                    CheckSaves();
                }
            }

            function LoadGame() {
                var check = window.localStorage.getItem("notice");
                if((typeof(check)!="string")||(check!="true")) {
                    LoadTemplate('notice');

                    window.localStorage.setItem("notice",true);
                }
                else {
                    LoadTemplate('game_page');
                }
            }

            function ToggleMenu() {
                var menu = document.getElementsByClassName('game_menu')[0];

                menu.style.display = (menu.style.display=="none")?"flex":"none";

                JournalCheck();
            }

            function JournalCheck() {
                var display = (HasJournal)?"flex":"none";

                document.getElementsByClassName('journal_button')[0].style="display:"+display;
            }
            
            function LoadPage(id) {
                var panel = document.body.getElementsByClassName('primary_panel');

                if(panel.length>0) {
                    panel[0].innerHTML=document.getElementById(id).innerHTML;
                }
            }

            // Render Logo
            function DrawLogo() {
                var w=7,g=4,s=5*w+4*g;
                var canvas = document.getElementsByClassName('logo')[0];

                if(canvas!=null) {
                    var ctx = canvas.getContext('2d');
                    ctx.fillStyle = DrawingColor;
                    ctx.fillRect(0,0,w,s);
                    ctx.fillRect(w,0,s-w,w);
                    ctx.fillRect(w,s-w,s-w,w);
                    ctx.fillRect(s-w,w,w,3*w+4*g);
                    ctx.fillRect(w+g,w+g,3*w+2*g,w);
                    ctx.fillRect(w+g,2*w+2*g,3*w+2*g,w);
                    ctx.fillRect(w+g,3*w+3*g,3*w+2*g,w);
                }
                
            }
        
            /*
                The intended structure of the localStorage data is as follows:
                    The "notice" key stores a boolean indicating that the notice has been seen.

                    The "saves" key stores an object tracking what save files exist.

                    The saves object is: {id,name,time} where
                        id is an array full of save ID numbers.
                        name is an array full of save names.
                        time is an array of when the save was last loaded.
                    
                    Save file objects are saved to their indice.
                    The only exception is the auto-save file.
                    The structure of a save file is {Journal} where:
                        Journal is an object tracking the state of the journal.
                
                The structure of the journal object is {Posession,Entries,Relationship} where:
                    Posession is a boolean tracking whether the player has the journal.
                    Entries is an array of entry objects that represent journal pages.
                    Relationship is an object tracking the nature of the player's
                        relationship with the journal.
                    
                The structure of an entry object is {Date,Passage,Image} where
                    Date indicates the in-game date the page is marked as.
                    Passage is an array of Text objects.
                    Image is an image that forms the background of the page.
                
                The structure of a Text object is {Source,Writing} where
                    Source indicates whether the player or the journal wrote something.
                        The players handwriting is somewhat sloppy while
                        the notebooks writing is more tidy.
                    Writing is the text content of the passage.
            */

            // Function updates the current auto save profile.
            function AutoSave() {
                CheckSaves();

                var newsave = {journal:Journal};

                window.localStorage.setItem("auto",JSON.stringify(newsave));

                var savedata = JSON.parse(window.localStorage.getItem("saves"));
                var indice = savedata.id.indexOf("auto");
                savedata.time[indice] = FormatDate(new Date(Date.now()));

                window.localStorage.setItem("saves",JSON.stringify(savedata));
            }

            // The following function attempts to load a save file.
            function LoadSave(saveid) {
                if(ValidateSave(saveid)) {
                    var savefile = JSON.parse(window.localStorage.getItem(saveid));
                    Journal = savefile.journal;

                    return(true);
                }
                else {
                    return(false);
                }
            }

            // Function confirms that save is formatted properly.
            function ValidateSave(saveid) {
                var savefile = null;

                try {
                    savefile = JSON.parse(window.localStorage.getItem(saveid));
                }
                catch(e) {
                    return(false);
                }

                if((savefile==null)||(typeof(savefile)!="object")) {
                    return(false);
                }
                else if((savefile.journal==null)||typeof(savefile.journal)!="object") {
                    return(false);
                }

                return(ValidateJournal(savefile.journal));
            }

            // Function confirms that journal is formatted properly.
            function ValidateJournal(journal) {
                if((journal.posession==null)||typeof(journal.posession)!="boolean") {
                    return(false);
                }
                else if((journal.entries==null)||!Array.isArray(journal.entries)) {
                    return(false);
                }
                else if((journal.relationship==null)||!Array.isArray(journal.relationship)) {
                    return(false);
                }

                if(ValidateEntries(journal.relationship)) {
                    return(ValidateRelationship(journal.entries));
                }
                else {
                    return(false);
                }
            }

            // Function that validates journal entries.
            function ValidateEntries(entries) {
                // TODO: write function.
                return(true);
            }

            // Function that validates relationship entries.
            function ValidateRelationship(relationship) {
                // TODO : write function.
                return(true);
            } 

            // Ensures that the saves object is present and correctly formatted.
            function CheckSaves() {
                var saves = window.localStorage.getItem("saves");
                var c1 = saves==null;

                // We make sure that saves is correctly formatted JSON data.
                try {
                    saves = JSON.parse(saves);
                }
                catch(e) {
                    c1 = 1;
                    saves = {};
                }

                if(saves==null) {
                    saves = {};
                }

                // We make shorthands for the objects we're looking at.
                var ids = saves.id;
                var names = saves.name;
                var times = saves.time;

                // We make sure that only the expected arrays are present.
                c1 = c1||(!Array.isArray(ids))||(!Array.isArray(names));
                c1 = c1||(!Array.isArray(times))||(Object.keys(saves).length!=3);

                // We make sure that the arrays contain expected data.
                // We also ensure that they contain the same amount of data.
                if(c1==false) {
                    c1 = !((ids.length==times.length)&&(ids.length==names.length));
                    
                    // The following ensures that only expected names are present.
                    for(var i = 0;(i<names.length)&&(c1==false);i++) {
                        if((typeof(names[i])!="string")||(names[i].length==0)) {
                            c1 = true;
                            break;
                        }
                    }

                    // The following ensures that only expected save IDs are present.
                    var indice = ids.indexOf("auto");
                    c1 = c1||(indice==-1);

                    for(var i = 0;(i<ids.length)&&(c1==false);i++) {
                        if(i==indice) {
                            continue;
                        }

                        var num = sids[i];

                        if((Number.isSafeInteger(num)==false)||(num<0)) {
                            c1 = true;
                        }
                    }

                    // Program is good up to this point.

                    // The following ensures that only proper times are present.
                    for(var i = 0;(i<times.length)&&(c1==false);i++) {
                        var pattern = /(\d{4})\/(\d{2})\/(\d{2}) @ (\d{2}):(\d{2}):(\d{2})/;
                        var base = times[i].match(pattern);

                        if(base.length<7) {
                            c1 = true;
                            break;
                        }
                        else {
                            base = base.splice(1,6);
                        }

                        var calc = [...base];
                        calc[1] = calc[1] - 1;

                        calc = Date.UTC(calc[0],calc[1],calc[2],calc[3],calc[4],calc[5]);
                        calc = new Date(calc);
                        calc = (FormatDate(calc)).match(pattern);

                        if(calc.length<7) {
                            c1 = true;
                            break;
                        }
                        else {
                            calc = calc.splice(1,6);
                        }

                        for(var j=0;j<base.length;j++) {
                            if(base[j]!=calc[j]) {
                                c1 = true;
                                break;
                            }
                        }
                    }
                }

                // If the saves object was malformed we scrub and reformat the local storage.
                if(c1) {
                    window.localStorage.clear();
                    saves = {id:["auto"],name:["auto"],time:[FormatDate(new Date(Date.now()))]};
                    window.localStorage.setItem("saves",JSON.stringify(saves));
                }
            }

            // Creates a new save file.
            function FirstAvailableSaveID() {
                var id=0;

                CheckSaves();

                var listedID = JSON.parse(window.localStorage.getItem("saves")).id;
                var recordedID = Object.keys(window.localStorage);
                var saves = listedID.concat(recordedID);

                while(1) {
                    if(0>saves.id.indexOf(id)) {
                        break;
                    }

                    id++;
                }

                return(id);
            }
            
            // The following turns a date into a string.
            function FormatDate(DateObject) {
                var base = [
                    DateObject.getFullYear(),
                    DateObject.getMonth()+1,
                    DateObject.getDate(),
                    DateObject.getHours(),
                    DateObject.getMinutes(),
                    DateObject.getSeconds()
                ];

                base = base.map(function(a){return(a.toString())});
                base = base.map(function(a){return(((a.length<2)?"0":"")+a)});

                var date = base[0] + "/" + base[1] + "/" + base[2];
                var time = base[3] + ":" + base[4] + ":" + base[5]; 

                return(date + " @ " + time);
            }

            // We create a new save file.
            function CreateNewSave(name) {
                var GoodName = (typeof(name)=="string")?name:JSON.stringify(name);
                GoodName = (GoodName=="null")?"Unnamed Save":GoodName;
                GoodName = (GoodName==undefined)?"Unnamed Save":GoodName;
                GoodName = (GoodName.length==0)?"Unnamed Save":GoodName;

                var saves=JSON.parse(window.localStorage.getItem("saves"));

                saves.id.push(FirstAvailableSaveID());
                saves.name.push(GoodName);
                saves.time.push(FormatDate(new Date(Date.now())));

                window.localStorage.setItem("saves",JSON.stringify(saves));
            }
        </script>

        <!-- Splash Page -->
        <template id="splash_screen">
            <div class="splash_page">
                <div class="splash_top">
                    <div class="splash_title">Within Cycles</div>
                </div>
                <div class="splash_bottom">
                    <div class="splash_button" onclick="LoadGame()">Start</div>
                    <div class="splash_button" onclick="Leave()">Leave</div>
                </div>
            </div>
        </template>

        <!-- Game Page Container -->
        <template id="game_page">
            <div class="game_container">
                <div class="game_header">
                    <canvas height="51px" width="51px" class="logo" onclick="ToggleMenu()">
                    </canvas>
                    <div class="banner_title">Within Cycles</div>
                </div>
                <div class="game_contents">
                    <div class="game_menu" style="display: none;">
                        <!-- Menu Options -->
                        <div class="menu_button_holster">
                            <div class="splash_button" onclick="LoadPage('the_world')">
                                The World
                            </div>
                        </div>
                        <div class="menu_button_holster journal_button">
                            <div class="splash_button" onclick="LoadPage('the_journal')">
                                Journal
                            </div>
                        </div>
                        <div class="menu_button_holster">
                            <div class="splash_button" onclick="LoadPage('save_data')">
                                Files Saves
                            </div>
                        </div>
                        <div class="menu_button_holster">
                            <div class="splash_button" onclick="LoadPage('game_settings')">
                                Settings
                            </div>
                        </div>
                        <div class="menu_button_holster">
                            <div class="splash_button" onclick="LoadPage('info')">
                                Information
                            </div>
                        </div>
                        <div class="menu_button_holster">
                            <div class="splash_button" onclick="LoadPage('help')">
                                Help
                            </div>
                        </div>
                        <div class="menu_button_holster">
                            <div class="splash_button" onclick="LoadPage('notice')">
                                Notice
                            </div>
                        </div>

                    </div>
                    <div class="primary_panel"></div>
                </div>
            </div>
        </template>

        <!-- Page where the game happens. -->
        <template id="the_world">
            <div class="narrator">
                <!-- Text that describes what is and has happeend goes here. -->
            </div>
            <div class="options">
                <!-- Text that describes what the player can do goes here. -->
            </div>
        </template>

        <!-- Journal Game Page -->
        <template id="the_journal"></template>

        <template id="save_data"></template>

        <template id="game_settings"></template>

        <template id="info"></template>

        <template id="help"></template>

        <template id="notice">
            <div class="game_container">
                <div class="info_text">
                    This is a browser-based text game, which means that gameplay consists of reading.
                    Furthermore, being made by a single person means
                    that any number of issues may be present (please let me know if you find any).
                </div>
                <div class="info_text">
                    Being a horror game merits the standard warning about
                    &mdash; well &mdash; horrific descriptions. Furthermore, if you are mentally or 
                    emotionally vulnerable I'm going to kindly ask that you only play this at the
                    recommendation of a good friend. If you are a minor please ask a parent or legal
                    guardian before playing this game.
                </div>
                <div class="info_text">
                    While playing this game there will be a button to access the menu in the
                    upper-left corner. This menu will allow you to redirect to a number of pages.
                    These pages range from more information about the game if you need it, 
                    to a page where you can manage save profiles (the game saves automatically
                    at specific points, but this gives you more control).
                    There is also a decorative settings page (no functionality yet).
                </div>
                <div class="info_text">
                    I apologize if this game doesn't seem like your cup of tea or if you become
                    frustrated or disappointed during the course of play. Regardless of how much
                    time you invest in this game, I appreciate you stopping by and I am grateful
                    for your patience. For those who wish to proceed &mdash; enjoy!
                </div>
                <div class="notice_options">
                    <div class="splash_button" onclick="Leave()">
                        Leave
                    </div>
                    <div class="splash_button" onclick="LoadTemplate('splash_screen')">
                        Return Home
                    </div>
                    <div class="splash_button" onclick="LoadTemplate('game_page')">
                        Continue
                    </div>
                </div>
            </div>
        </template>
    </head>
    
    <body onload="LoadTemplate('splash_screen')"></body>
</html>
